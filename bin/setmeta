#!/bin/env python
from mutagen import id3
import subprocess
import sys

def change_meta(meta, audio):
    """
    Change the metadata of an mp3 file.
    """

    audio.add(id3.TIT2(encoding=3, text=[meta['title']]))
    audio.add(id3.TALB(encoding=3, text=[meta['album']]))
    audio.add(id3.TPE1(encoding=3, text=[meta['artist']]))
    audio.add(id3.TPE2(encoding=3, text=[meta['albumartist']]))
    audio.add(id3.TDRC(encoding=3, text=meta['year']))
    audio.add(id3.TRCK(encoding=3, text=meta['trackno']))

def ask_meta():
    return {
        'title':        input('          title: '),
        'album':        input('          album: '),
        'artist':       input('         artist: '),
        'albumartist':  input('    albumartist: '),
        'year':         input('           year: '),
        'trackno':      input('        trackno: '),
    }

print('Metadata fixup dialog.')
print('At any point, press CTRL+C to abort.')

# set metadata
for fname in sys.argv[1:]:
    print('\n===')
    print('Metadata for: ' + fname)
    audio = id3.ID3(fname)
    print(audio.pprint())
    change_meta(ask_meta(), audio)
    audio.save()
    subprocess.run(["rsgain", "custom", "-s", "i", fname])
    print('Done: ' + fname)
